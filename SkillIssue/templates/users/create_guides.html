{% load static %}
<html>
<head>
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header class="header" id="header">
        <nav class="header-container">
            <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
            <div class="nav-group nav-group-left">
                <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞" data-lang-en="guides">—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</a>
                <a class="nav-links" href="{% url 'announcements_list' %}" data-lang-ru="–æ–±—ä—è–≤–ª–µ–Ω–∏—è" data-lang-en="announcements">–æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            </div>
            <div class="nav-group nav-group-right">
                <div class="search-container">
                    <input class="search" placeholder="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π" id="searchInput"
                           data-placeholder-ru="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π"
                           data-placeholder-en="search guides, announcements and profiles">
                    <div class="search-dropdown" id="searchDropdown">
                    </div>
                </div>
                <button id="theme-toggle" onclick="window.toggleTheme(event)" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
                <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫">RU</a>
                <div class="menu-container">
                    {% if user.is_authenticated %}
                        <a class="nav-links"
                           href="{% url 'profile_page' user.username %}"
                           data-lang-ru="–ø—Ä–æ—Ñ–∏–ª—å"
                           data-lang-en="profile"
                           style="margin-right: 24px;">–ø—Ä–æ—Ñ–∏–ª—å</a>
                    {% else %}
                        <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                        <div class="context-menu">
                            <a href="{% url 'register_page' %}" data-lang-ru="–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-lang-en="register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                            <a href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </nav>
    </header>

    <div class="body-background">
        <h1 id="pageTitle" class="simple-text" style="margin-top: 20px; font-size: 1.5rem;"
            data-lang-ru="{% if guide %}–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ{% else %}–ù–∞—á–Ω–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ—ë —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ!{% endif %}"
            data-lang-en="{% if guide %}Edit the guide{% else %}Start creating your guide!{% endif %}">
            {% if guide %}–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ{% else %}–ù–∞—á–Ω–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ—ë —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ!{% endif %}
        </h1>
        <a class="simple-text" style="margin-top: 0; font-size: 0.8rem; color:#424242; margin-bottom: 20px"
           data-lang-ru="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ä–∞–∑–º–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é markdown"
           data-lang-en="Markdown formatting is supported">
            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ä–∞–∑–º–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é markdown
        </a>

        <div class="editor-container">
            <input id="titleInput" type="text" class="guide_name_input"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞"
                   data-placeholder-ru="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞"
                   data-placeholder-en="Enter guide title"
                   value="{% if guide %}{{ guide.title|escape }}{% endif %}">
            
            <input id="tagsInput" type="text" class="guide_name_input"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: Python, Django, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)"
                   data-placeholder-ru="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: Python, Django, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)"
                   data-placeholder-en="Enter tags separated by commas (e.g. Python, Django, programming)"
                   value="{% if guide %}{{ guide.tags|join:', ' }}{% endif %}"
                   style="margin-top: 10px;">

            <div class="editor-section">
                <div class="editor-header">
                    <div class="toolbar">
                        <button class="toolbar-btn" onclick="insertText('**', '**')" title="–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç" data-lang-ru-title="–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç" data-lang-en-title="Bold">**B**</button>
                        <button class="toolbar-btn" onclick="insertText('*', '*')" title="–ö—É—Ä—Å–∏–≤" data-lang-ru-title="–ö—É—Ä—Å–∏–≤" data-lang-en-title="Italic">*I*</button>
                        <button class="toolbar-btn" onclick="insertText('# ', '')" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1" data-lang-ru-title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1" data-lang-en-title="Heading 1">H1</button>
                        <button class="toolbar-btn" onclick="insertText('## ', '')" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2" data-lang-ru-title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2" data-lang-en-title="Heading 2">H2</button>
                        <button class="toolbar-btn" onclick="insertText('- ', '')" title="–°–ø–∏—Å–æ–∫" data-lang-ru-title="–°–ø–∏—Å–æ–∫" data-lang-en-title="List">-</button>
                        <button class="toolbar-btn" onclick="insertText('```\n', '\n```')" title="–ë–ª–æ–∫ –∫–æ–¥–∞" data-lang-ru-title="–ë–ª–æ–∫ –∫–æ–¥–∞" data-lang-en-title="Code block">```</button>
                        <button class="toolbar-btn" onclick="insertText('> ', '')" title="–¶–∏—Ç–∞—Ç–∞" data-lang-ru-title="–¶–∏—Ç–∞—Ç–∞" data-lang-en-title="Quote">></button>
                        <input type="file" id="imageInput" class="file-input" accept="image/*" onchange="handleImageUpload()">
                        <label for="imageInput" class="file-label" data-lang-ru="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" data-lang-en="Image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                    </div>
                </div>
                <textarea id="markdownEditor"
                          placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –≤–∞—à–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∑–¥–µ—Å—å..."
                          data-placeholder-ru="–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –≤–∞—à–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∑–¥–µ—Å—å..."
                          data-placeholder-en="Start writing your guide here...">
                    {% if guide %}{{ guide.content|escape }}{% endif %}
                </textarea>
            </div>

            <div class="preview-section">
                <div class="preview-header">
                    <h3 style="line-height: 0; margin-top:5px" data-lang-ru="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" data-lang-en="Preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
                </div>
                <div id="preview" class="preview-content">
                    <em style="color: #666;" data-lang-ru="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..." data-lang-en="Preview will appear here...">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</em>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="profile-button" onclick="clearEditor()" data-lang-ru="–û—á–∏—Å—Ç–∏—Ç—å" data-lang-en="Clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="profile-button" onclick="saveGuide()" data-lang-ru="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" data-lang-en="Save guide">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ</button>
            {% if guide %}
            <button class="profile-button"
                    id="delete-guide-btn"
                    style="background-color:#ff5c5c; border:none;"
                    data-lang-ru="–£–¥–∞–ª–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ"
                    data-lang-en="Delete guide">
                –£–¥–∞–ª–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
            </button>
            {% endif %}
        </div>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <table class="simple-text" style="width: 100%; height: 100%; color: lightgray; font-size: 1rem">
                <tr>
                    <td colspan="3" style="width:33%;"><a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration: none; color: lightgray; margin-bottom: auto; margin-top: 5px; font-size: 1.25rem "
                           data-lang-ru="–°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç"
                           data-lang-en="Siberian Federal University">–°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</a>
                    </td>
                    <td style="text-align:right"><p class="nav-group-right" style="margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;">@skill_issue 2025</p>
                    </td>
                </tr>
                <tr>
                    <td><p style="text-align:left">@bukohm</p>
                    </td>
                    <td><p style="text-align:center">@hoolkayyy</p>
                    </td>
                    <td><p style="text-align:right">@K1rkaSs</p>
                    </td>
                </tr>
            </table>
        </div>
    </footer>

<script>
const editor = document.getElementById('markdownEditor');
const preview = document.getElementById('preview');
const titleInput = document.getElementById('titleInput');
const tagsInput = document.getElementById('tagsInput');
const pageTitle = document.getElementById('pageTitle');
let guideId = null;

const imageStorage = new Map();
let imageCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    guideId = urlParams.get('id');

    if (guideId) {
        const lang = localStorage.getItem('lang') || 'RU';
        pageTitle.textContent = lang === 'RU' ? "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" : "Edit the guide";

        fetch(`/api/guides/${guideId}/`)
            .then(response => {
                if (!response.ok) throw new Error('Guide not found');
                return response.json();
            })
            .then(data => {
                titleInput.value = data.title;
                editor.value = data.content;
                if (data.tags && Array.isArray(data.tags)) {
                    tagsInput.value = data.tags.join(', ');
                }

                const imageRegex = /!\[(.*?)\]\((.*?)\)/g;
                let match;
                while ((match = imageRegex.exec(data.content)) !== null) {
                    const altText = match[1];
                    const fileName = match[2];

                    if (!fileName.startsWith("http")) {
                        const imageUrl = `/media/guides/${fileName}`;
                        imageStorage.set(fileName, { url: imageUrl, name: altText || fileName });
                    }
                }

                updatePreview();
            })
            .catch(err => console.error(err));
    }

    updatePreview();

    const deleteGuideBtn = document.getElementById('delete-guide-btn');
    if (deleteGuideBtn && guideId) {
        deleteGuideBtn.addEventListener('click', async () => {
            const lang = localStorage.getItem('lang') || 'RU';
            const confirmMsg = lang === 'RU'
                ? '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.'
                : 'Delete this guide? This action cannot be undone.';
            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch(`/api/guides/${guideId}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') || '' },
                    credentials: 'same-origin'
                });

                if (!res.ok) {
                    throw new Error(lang === 'RU' ? '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ' : 'Failed to delete guide');
                }

                window.location.href = "{% url 'guides_list' %}";
            } catch (err) {
                alert(err.message || (lang === 'RU' ? '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏' : 'Error deleting'));
            }
        });
    }
});

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}


function insertText(before, after) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end);
    const newText = editor.value.substring(0, start) + before + selectedText + after + editor.value.substring(end);

    editor.value = newText;
    editor.focus();
    editor.setSelectionRange(start + before.length, end + before.length);

    updatePreview();
}

function handleImageUpload() {
    const fileInput = document.getElementById('imageInput');
    const files = fileInput.files;

    if (files.length > 0) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;

                imageStorage.set(file.name, { url: imageUrl, name: file.name, file: file });

                const markdownImage = `![${file.name}](${file.name})`;
                const start = editor.selectionStart;
                const newText = editor.value.substring(0, start) + '\n' + markdownImage + '\n' + editor.value.substring(start);
                editor.value = newText;

                updatePreview();
            };
            reader.readAsDataURL(file);
        });

        fileInput.value = '';
    }
}

function updatePreview() {
    const markdownText = editor.value;
    const html = markdownToHtml(markdownText);
    preview.innerHTML = html;
}

function markdownToHtml(markdown) {
    if (!markdown.trim()) {
        const lang = localStorage.getItem('lang') || 'RU';
        const placeholder = lang === 'RU'
            ? '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...'
            : 'Preview will appear here...';
        return `<em style="color: #666;">${placeholder}</em>`;
    }

    let html = markdown;

    html = html.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, path) => {
    if (imageStorage.has(path)) {
        const imageData = imageStorage.get(path);
        return `<img src="${imageData.url}" alt="${alt || imageData.name}" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">`;
    } else if (!path.startsWith("http")) {
        return `<img src="/media/guides/${path}" alt="${alt}" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">`;
    }
    return `<img src="${path}" alt="${alt}" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">`;
});

    html = html.replace(/!\[(.*?)\]\((http[^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">');

    html = html
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/gim, '<em>$1</em>')
        .replace(/\[(.*?)\]\((?!image_)(.*?)\)/gim, '<a href="$2" target="_blank">$1</a>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
        .replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>')
        .replace(/<\/ul>\s*<ul>/g, '')
        .replace(/\n/g, '<br>');

    return html;
}

function clearEditor() {
    const lang = localStorage.getItem('lang') || 'RU';
    const confirmMsg = lang === 'RU'
        ? '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä?'
        : 'Are you sure you want to clear the editor?';
    if (confirm(confirmMsg)) {
        editor.value = '';
        titleInput.value = '';
        tagsInput.value = '';
        imageStorage.clear();
        imageCounter = 0;
        updatePreview();
    }
}

async function saveGuide() {
    const guideTitle = titleInput.value.trim();
    const content = editor.value;
    const tags = tagsInput.value.trim();

    const lang = localStorage.getItem('lang') || 'RU';
    const alertMsg = lang === 'RU'
        ? "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç"
        : "Please enter title and content";

    if (!guideTitle || !content.trim()) {
        alert(alertMsg);
        return;
    }

    const formData = new FormData();
    formData.append("title", guideTitle);
    formData.append("content", content);
    formData.append("tags", tags);

    for (const [fileName, value] of imageStorage.entries()) {
        if (value.file) {
            formData.append("image", value.file);
        }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const guideId = urlParams.get('id');
    const url = guideId ? `/create_guide/?id=${guideId}` : "{% url 'create_guide' %}";

    const response = await fetch(url, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    });

    if (response.ok) {
        const successMsg = lang === 'RU'
            ? "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"
            : "Guide saved successfully!";
        alert(successMsg);
        window.location.href = guideId ? `/guides/${guideId}/` : "{% url 'guides_list' %}";
    } else {
        const errorMsg = lang === 'RU'
            ? "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞"
            : "Failed to save guide";
        alert(errorMsg);
    }
}

editor.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const spaces = '    ';
        this.value = this.value.substring(0, start) + spaces + this.value.substring(end);
        this.selectionStart = this.selectionEnd = start + spaces.length;
        updatePreview();
    }
});

editor.addEventListener('input', updatePreview);

</script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
<script src="{% static 'js/theme.js' %}"></script>
</body>
</html>