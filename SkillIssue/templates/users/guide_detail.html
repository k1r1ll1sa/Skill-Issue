{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ guide.title }} ‚Äî Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
<header class="header" id="header">
    <nav class="header-container">
        <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
        <div class="nav-group nav-group-left">
            <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞" data-lang-en="guides">—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</a>
            <a class="nav-links" href="{% url 'announcements_list' %}" data-lang-ru="–æ–±—ä—è–≤–ª–µ–Ω–∏—è" data-lang-en="announcements">–æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
        </div>
        <div class="nav-group nav-group-right">
            <div class="search-container">
                <input class="search" placeholder="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π" id="searchInput"
                       data-placeholder-ru="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π"
                       data-placeholder-en="search guides, profiles and announcements">
                <div class="search-dropdown" id="searchDropdown">
                </div>
            </div>
            <button id="theme-toggle" onclick="window.toggleTheme(event)" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
            <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫">RU</a>
            {% if user.is_authenticated %}
                <a class="nav-links"
                   href="{% url 'profile_page' user.username %}"
                   data-lang-ru="–ø—Ä–æ—Ñ–∏–ª—å"
                   data-lang-en="profile"
                   style="margin-right: 24px;">–ø—Ä–æ—Ñ–∏–ª—å</a>
            {% else %}
                <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
            {% endif %}
        </div>
    </nav>
</header>

<div class="body-background">
    <a class="simple-text" style="font-size: 2rem; margin: 10px 0;">{{ guide.title }}</a>

    <div class="profile-row-container" style="margin: 10px 0; gap: 20px; justify-content: center;">
        <a class="simple-text" style="font-size: 1.5rem" href="{% url 'profile_page' guide.author.username %}">
            {{ guide.author.username }}
        </a>
        <a class="simple-text" id="guide-rating" style="font-size: 1.5rem">
            <span data-lang-ru="–†–µ–π—Ç–∏–Ω–≥: " data-lang-en="Rating: ">–†–µ–π—Ç–∏–Ω–≥: </span>{{ guide.rating }}/5
        </a>
    </div>

    <div id="preview" class="preview-content"
         style="width: 95%; margin: auto; box-shadow: 0px 1px 3px #424242; padding: 20px;">
        {% if guide_content_html %}
            {{ guide_content_html|safe }}
        {% else %}
            <em style="color: #666;">–ö–æ–Ω—Ç–µ–Ω—Ç —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</em>
        {% endif %}
    </div>

    {% if user.is_authenticated and user == guide.author %}
    <form action="{% url 'create_guide' %}" method="get" style="margin: 0; margin-left: auto; display: inline-block;">
        <input type="hidden" name="id" value="{{ guide.id }}">
        <button class="profile-button" style="height: 40px; width: 200px; border:none; box-shadow: 0px 1px 3px #424242; margin-top: 20px;"
                data-lang-ru="—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" data-lang-en="edit">—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </form>
    {% endif %}

    <hr style="color: black; width: 96%; margin: 20px auto;">
    <a class="simple-text" style="line-height: 20px; padding-bottom: 20px;">–û—Ç–∑—ã–≤—ã –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É</a>

    <div id="reviews-container" class="profile-column-container" style="gap: 20px;">
        {% for review in reviews %}
        <div class="profile-column-container review-block"
             data-review-id="{{ review.id }}">
            <div class="profile-row-container">
                {% if review.author.profile.avatar %}
                    <img src="{{ review.author.profile.avatar.url }}" class="rec_avatar">
                {% else %}
                    <img src="{% static 'images/default-avatar.jpg' %}" class="rec_avatar">
                {% endif %}
                <div class="profile-column-container">
                    <a href="{% url 'profile_page' review.author.username %}"
                       class="simple-text"
                       style="font-size: 1rem; padding-left: 10px">
                        {{ review.author.username }}
                    </a>
                    <a class="simple-text" style="font-size: 0.8rem; color: #444; padding-left: 10px">
                        {{ review.created_at|date:"d.m.Y" }}
                    </a>
                </div>

                <a class="simple-text review-stars" style="font-size:1rem; margin-left:auto;">‚≠ê {{ review.stars }}</a>

                {% if review.author == user %}
                    <button class="profile-button edit-review-btn"
                            data-review-id="{{ review.id }}"
                            data-review-stars="{{ review.stars }}"
                            data-review-text="{{ review.text|escapejs }}"
                            style="margin-left:10px; height:30px;">
                        ‚úé
                    </button>
                    <button class="profile-button delete-review-btn"
                            data-review-id="{{ review.id }}"
                            style="margin-left:5px; height:30px; background-color:#FF6347; color:white; min-width: auto; padding: 0 10px">
                        üóë
                    </button>
                {% endif %}
            </div>

            <a class="simple-text review-text" style="text-align: left; font-size:1rem; padding-top:5px;">{{ review.text }}</a>
        </div>
        {% empty %}
        <p class="simple-text" style="text-align:center;">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
        {% endfor %}
    </div>

    {% if user.is_authenticated and user != guide.author %}
        <hr style="color: black; width: 96%; margin: 20px auto;">
        <a class="simple-text" id="form-title">–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –æ—Ç–∑—ã–≤</a>

        <form id="review-form" method="POST" style="width:80%; margin:auto;">
            {% csrf_token %}
            <input type="hidden" id="review-id-edit" value="">
            <textarea id="review-text" name="text" class="textarea_profile"
                      placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –∑–¥–µ—Å—å"></textarea>

            <a id="error" hidden class="simple-text"
               style="font-size:1rem; margin:10px auto; margin-top:-10px; color:red;">
                –û—Ç–∑—ã–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!
            </a>

            <div id="rating-container" class="profile-row-container" style="margin:auto; gap:10px;">
                <button class="star-button" data-value="1">‚òÖ</button>
                <button class="star-button" data-value="2">‚òÖ</button>
                <button class="star-button" data-value="3">‚òÖ</button>
                <button class="star-button" data-value="4">‚òÖ</button>
                <button class="star-button" data-value="5">‚òÖ</button>

                <button id="response-btn" class="profile-button"
                        style="width:20%; height:40px; border:none; box-shadow:0px 1px 3px #424242;"
                        type="submit">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
    {% endif %}
</div>

<footer class="footer"></footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star-button');
    const textarea = document.getElementById('review-text');
    const reviewIdInput = document.getElementById('review-id-edit');
    const errorEl = document.getElementById('error');
    const form = document.getElementById('review-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('response-btn');
    const reviewsContainer = document.getElementById('reviews-container');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const guideId = "{{ guide.id }}";

    let currentRating = 0;

    function updateStars(r) {
        stars.forEach(star => {
            const val = parseInt(star.dataset.value);
            star.style.backgroundColor = val <= r ? '#00BFFF' : '#f0f0f0';
            star.style.color = val <= r ? '#fff' : '#666';
        });
    }

    stars.forEach(star => {
        star.addEventListener('click', (e) => {
            e.preventDefault();
            currentRating = parseInt(star.dataset.value);
            updateStars(currentRating);
        });
    });

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞
    document.querySelectorAll('.edit-review-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const reviewId = btn.dataset.reviewId;
            const text = btn.dataset.reviewText;
            const starsValue = parseInt(btn.dataset.reviewStars);

            currentRating = starsValue;
            updateStars(currentRating);
            textarea.value = text;
            reviewIdInput.value = reviewId;

            submitBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
            formTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤";
        });
    });

    document.querySelectorAll('.delete-review-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const reviewId = btn.dataset.reviewId;
            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?")) return;

            fetch(`/api/reviews/${reviewId}/delete/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": csrfToken
                }
            }).then(res => res.json())
              .then(data => {
                  if (data.error) {
                      alert(data.error);
                      return;
                  }
                  // –£–¥–∞–ª—è–µ–º –±–ª–æ–∫ –æ—Ç–∑—ã–≤–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                  const block = document.querySelector(`.review-block[data-review-id="${reviewId}"]`);
                  block.remove();

                  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≥–∏–¥–∞
                  if (data.guide_average_rating !== undefined) {
                      document.getElementById('guide-rating').textContent = `–†–µ–π—Ç–∏–Ω–≥: ${Math.floor(data.guide_average_rating)}/5`;
                  }

                  // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ—Ñ–∏–ª—è
                  const profileRatingEl = document.querySelector('.profile-rating');
                  if (profileRatingEl) {
                      profileRatingEl.textContent = `–†–µ–π—Ç–∏–Ω–≥: ${data.profile_average_rating}/5`;
                  }
              });
        });
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!textarea.value.trim() || currentRating === 0) {
            errorEl.removeAttribute('hidden');
            return;
        }
        errorEl.setAttribute('hidden', 'true');

        const reviewId = reviewIdInput.value;
        const isUpdate = reviewId !== "";
        const url = isUpdate ? `/api/reviews/${reviewId}/update/` : `/api/reviews/create/`;
        const method = isUpdate ? "PUT" : "POST";

        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({
                guide_id: guideId,
                text: textarea.value,
                stars: currentRating
            })
        }).then(res => res.json())
          .then(data => {
              if (data.error) {
                  alert(data.error);
                  return;
              }

              // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∑–≤–µ–∑–¥—ã –æ—Ç–∑—ã–≤–∞
              if (isUpdate) {
                  const block = document.querySelector(`.review-block[data-review-id="${reviewId}"]`);
                  block.querySelector('.review-text').textContent = textarea.value;
                  block.querySelector('.review-stars').textContent = `‚≠ê ${currentRating}`;
              } else {
                  location.reload(); // –ò–ª–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤
              }

              // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≥–∏–¥–∞
              if (data.guide_average_rating !== undefined) {
                  document.getElementById('guide-rating').textContent = `–†–µ–π—Ç–∏–Ω–≥: ${Math.floor(data.guide_average_rating)}/5`;
              }

              // –ï—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ—Ñ–∏–ª—è
              const profileRatingEl = document.querySelector('.profile-rating');
              if (profileRatingEl) {
                  profileRatingEl.textContent = `–†–µ–π—Ç–∏–Ω–≥: ${data.profile_average_rating}/5`;
              }

              textarea.value = "";
              currentRating = 0;
              updateStars(0);
              reviewIdInput.value = "";
              submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
              formTitle.textContent = "–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –æ—Ç–∑—ã–≤";
          });
    });

    updateStars(0);
});
</script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
<script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
