{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header class="header" id="header">
        <nav class="header-container">
            <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
            <div class="nav-group nav-group-left">
                <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞" data-lang-en="guides">—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</a>
                <a class="nav-links" href="{% url 'announcements_list' %}" data-lang-ru="–æ–±—ä—è–≤–ª–µ–Ω–∏—è" data-lang-en="announcements">–æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            </div>
            <div class="nav-group nav-group-right">
                <div class="search-container">
                    <input class="search" placeholder="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π" id="searchInput"
                           data-placeholder-ru="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π"
                           data-placeholder-en="search guides, profiles and announcements">
                    <div class="search-dropdown" id="searchDropdown">
                    </div>
                </div>
                <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫">RU</a>
                <div class="menu-container" id="menu-container">
                    <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                    <div class="context-menu">
                        <a href="{% url 'register_page' %}" data-lang-ru="–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-lang-en="register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                        <a href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="body-background">
        <img src="{% static 'images/logo.png' %}" alt="Skill Issue logo"
             style="width: 40%; height: auto; margin-top: 50px;">
        <br><br>
        <hr style="width: 50%; color: ghostwhite">
        <p class="logo" style="color: black; font-size: 2.5rem">Skill Issue</p>
        <hr style="width: 40%; color: ghostwhite">
        <p class="simple-text" style="margin-top: 5px" data-lang-ru="–ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ–±–º–µ–Ω–∞ –Ω–∞–≤—ã–∫–∞–º–∏" data-lang-en="project for finding and sharing skills">–ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ–±–º–µ–Ω–∞ –Ω–∞–≤—ã–∫–∞–º–∏</p>
        <div class="carousel-container">
            <div class="carousel" id="carousel">
                <!-- –°–ª–∞–π–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <button class="carousel-btn prev" onclick="moveSlide(-1)" aria-label="Previous slide">&lt;</button>
            <button class="carousel-btn next" onclick="moveSlide(1)" aria-label="Next slide">&gt;</button>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
            <div class="carousel-indicators" id="carouselIndicators"></div>
        </div>
    </div>

    <!-- –ß–∞—Ç -->
    <button type="button" id="floating-button" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
        üí¨
    </button>

    <div id="chat-modal" >
        <div id="chat-contacts">
            <div id="chat-header">
                <span>–ß–∞—Ç—ã</span>
                <button id="chat-close-button">&times;</button>
            </div>
            <!--–°–ü–ò–°–û–ö –ö–û–ù–¢–ê–ö–¢–û–í-->
            <div id="chat-list">
                <a href="#" class="chat-item" data-user-id="1">
                    <img src="{% static 'images/default-avatar.jpg' %}" alt="Avatar">
                    <div style="flex: 1;">
                        <div class="username">–ê–ª–µ–∫—Å–µ–π</div>
                    </div>
                </a>
                <a href="#" class="chat-item" data-user-id="2">
                    <img src="{% static 'images/default-avatar.jpg' %}" alt="Avatar">
                    <div style="flex: 1;">
                        <div class="username">–ú–∞—Ä–∏—è</div>
                    </div>
                </a>
            </div>
        </div>

        <div id="chat-dialog" style="display: none;">
            <div id="dialog-header">
                <button id="back-to-chats">&lt;</button>
                <img id="dialog-avatar" src="{% static 'images/default-avatar.jpg' %}" alt="Avatar">
                <a id="profile-link" href="#">–ù–∏–∫–Ω–µ–π–º</a>
            </div>

            <div id="messages-container" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-color: #f9f9f9;"></div>

            <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #eee;">
                <form id="message-form" style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                           style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 0.95rem;" autocomplete="off">
                    <button type="submit" style="
                        background: linear-gradient(135deg, #00BFFF 0%, #0099CC 100%);
                        color: white;
                        border: none;
                        border-radius: 20px;
                        padding: 10px 24px;
                        font-size: 0.95rem;
                        font-weight: 600;
                        cursor: pointer;
                        box-shadow: 0 2px 8px rgba(0, 191, 255, 0.3);
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        min-width: 100px;
                    " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0, 191, 255, 0.4)';" 
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0, 191, 255, 0.3)';">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- –ö–æ–Ω–µ—Ü —á–∞—Ç–∞ -->

    <footer class="footer">
        <div class="footer-container">
            <table class="simple-text" style="width: 100%; height: 100%; color: lightgray; font-size: 1rem">
                <tr>
                    <td colspan="3" style="width:33%;">
                        <a href="https://www.sfu.ru/ru" class="nav-group-left"
                           style="text-decoration: none; color: lightgray; margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;"
                           data-lang-ru="–°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç" data-lang-en="Siberian Federal University">
                           –°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
                        </a>
                    </td>
                    <td style="text-align:right;">
                        <p class="nav-group-right" style="margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;">@skill_issue 2025</p>
                    </td>
                </tr>
                <tr>
                    <td><p style="text-align:left">@bukohm</p></td>
                    <td><p style="text-align:center">@hoolkayyy</p></td>
                    <td><p style="text-align:right">@K1rkaSs</p></td>
                </tr>
            </table>
        </div>
    </footer>

<script src="{% static 'js/auth.js' %}"></script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/toggle_chat.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
<script src="{% static 'js/filter.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const menuContainer = document.querySelector(".menu-container");

    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º authManager –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å JWT —Ç–æ–∫–µ–Ω–æ–º
        const response = await authManager.apiRequest("/api/me/");

        if (response.ok) {
            const user = await response.json();
            menuContainer.innerHTML = `
                <a class="nav-links" href="/users/${user.username}/" style="margin-right: 20px;" data-lang-ru="–ø—Ä–æ—Ñ–∏–ª—å" data-lang-en="profile">–ø—Ä–æ—Ñ–∏–ª—å</a>
            `;
            setTimeout(() => {
                if (typeof applyLanguage === 'function') {
                    applyLanguage(currentLang);
                }
            }, 100);

            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    authManager.logout();
                });
            }
        } else {
            menuContainer.innerHTML = `
                <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                <div class="context-menu">
                    <a href="{% url 'register_page' %}" data-lang-ru="–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-lang-en="register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                    <a href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                </div>
            `;
            setTimeout(() => {
                if (typeof applyLanguage === 'function') {
                    applyLanguage(currentLang);
                }
            }, 100);
        }
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏", err);
        menuContainer.innerHTML = `
            <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
            <div class="context-menu">
                <a href="{% url 'register_page' %}" data-lang-ru="–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-lang-en="register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
            </div>
        `;
        setTimeout(() => {
            if (typeof applyLanguage === 'function') {
                applyLanguage(currentLang);
            }
        }, 100);
    }
});
</script>
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏
    let currentSlide = 0;
    let totalSlides = 0;
    let slides = [];
    let carousel = null;
    let indicatorsContainer = null;

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–∞—Ä—É—Å–µ–ª–∏
    function moveSlide(direction) {
        goToSlide(currentSlide + direction);
    }

    function goToSlide(index) {
        if (totalSlides === 0) return;
        if (index < 0) index = totalSlides - 1;
        if (index >= totalSlides) index = 0;
        currentSlide = index;
        updateCarousel();
    }

    function updateCarousel() {
        if (!carousel || totalSlides === 0) return;
        carousel.style.transform = `translateX(-${currentSlide * 100}%)`;
        const indicators = document.querySelectorAll('.indicator');
        indicators.forEach((ind, idx) => {
            ind.classList.toggle('active', idx === currentSlide);
        });
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ API
    async function loadPopularItems() {
        if (!carousel || !indicatorsContainer) {
            carousel = document.getElementById('carousel');
            indicatorsContainer = document.getElementById('carouselIndicators');
        }
        
        if (!carousel || !indicatorsContainer) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –∫–∞—Ä—É—Å–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        try {
            const response = await fetch('/api/popular-items/');
            if (!response.ok) {
                throw new Error('Failed to load popular items');
            }
            const data = await response.json();
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ API –∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å–∞–º–∏
            const allItems = data.items || [...(data.guides || []), ...(data.announcements || [])];
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            if (allItems.length === 0) {
                loadDefaultSlides();
                return;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const itemsToShow = allItems.slice(0, 6);
            totalSlides = itemsToShow.length;
            
            // –û—á–∏—â–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å
            carousel.innerHTML = '';
            indicatorsContainer.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —Å–ª–∞–π–¥—ã
            itemsToShow.forEach((item, index) => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';
                slide.style.cursor = 'pointer';
                
                // –î–µ–ª–∞–µ–º —Å–ª–∞–π–¥ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
                slide.addEventListener('click', () => {
                    window.location.href = item.url;
                });
                
                const imageUrl = item.image || "{% static 'images/default-announcement.png' %}";
                const imageAlt = item.title || 'Image';
                
                slide.innerHTML = `
                    <img src="${imageUrl}" alt="${imageAlt}" onerror="this.src='{% static 'images/default-announcement.png' %}'">
                    <div class="slide-caption">
                        <div class="slide-title">${escapeHtml(item.title)}</div>
                        <div class="slide-author">
                            ${item.type === 'guide' 
                                ? `<span data-lang-ru="–ê–≤—Ç–æ—Ä: ${escapeHtml(item.author)}" data-lang-en="Author: ${escapeHtml(item.author)}">–ê–≤—Ç–æ—Ä: ${escapeHtml(item.author)}</span>`
                                : `<span data-lang-ru="–ê–≤—Ç–æ—Ä: ${escapeHtml(item.author)}" data-lang-en="Author: ${escapeHtml(item.author)}">–ê–≤—Ç–æ—Ä: ${escapeHtml(item.author)}</span>`
                            }
                            ${item.rating !== undefined ? ` <span style="color: gold;">‚òÖ ${item.rating}</span>` : ''}
                        </div>
                    </div>
                `;
                
                carousel.appendChild(slide);
                
                // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                const indicator = document.createElement('div');
                indicator.classList.add('indicator');
                if (index === 0) indicator.classList.add('active');
                indicator.addEventListener('click', () => goToSlide(index));
                indicatorsContainer.appendChild(indicator);
            });
            
            slides = document.querySelectorAll('.carousel-slide');
            updateCarousel();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —è–∑—ã–∫–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if (typeof applyLanguage === 'function') {
                setTimeout(() => {
                    applyLanguage(currentLang || 'RU');
                }, 100);
            }
        } catch (error) {
            console.error('Error loading popular items:', error);
            loadDefaultSlides();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö —Å–ª–∞–π–¥–æ–≤ (–µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    function loadDefaultSlides() {
        if (!carousel || !indicatorsContainer) {
            carousel = document.getElementById('carousel');
            indicatorsContainer = document.getElementById('carouselIndicators');
        }
        
        if (!carousel || !indicatorsContainer) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –∫–∞—Ä—É—Å–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        const defaultSlides = [
            {
                image: "{% static 'images/default-announcement.png' %}",
                title: "–û—Å–Ω–æ–≤—ã Python",
                author: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
                url: "#"
            },
            {
                image: "{% static 'images/default-avatar.jpg' %}",
                title: "–í–µ–±-–¥–∏–∑–∞–π–Ω",
                author: "–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞",
                url: "#"
            },
            {
                image: "{% static 'images/default-avatar.jpg' %}",
                title: "Git –∏ GitHub",
                author: "–ê–ª–µ–∫—Å–µ–π –ö–æ–∑–ª–æ–≤",
                url: "#"
            }
        ];
        
        totalSlides = defaultSlides.length;
        carousel.innerHTML = '';
        indicatorsContainer.innerHTML = '';
        
        defaultSlides.forEach((item, index) => {
            const slide = document.createElement('div');
            slide.className = 'carousel-slide';
            slide.innerHTML = `
                <img src="${item.image}">
                <div class="slide-caption">
                    <div class="slide-title" data-lang-ru="${item.title}" data-lang-en="${item.title}">${item.title}</div>
                    <div class="slide-author" data-lang-ru="–ê–≤—Ç–æ—Ä: ${item.author}" data-lang-en="Author: ${item.author}">–ê–≤—Ç–æ—Ä: ${item.author}</div>
                </div>
            `;
            carousel.appendChild(slide);
            
            const indicator = document.createElement('div');
            indicator.classList.add('indicator');
            if (index === 0) indicator.classList.add('active');
            indicator.addEventListener('click', () => goToSlide(index));
            indicatorsContainer.appendChild(indicator);
        });
        
        slides = document.querySelectorAll('.carousel-slide');
        updateCarousel();
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
        loadPopularItems();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Å–ª–∞–π–¥–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (totalSlides > 0) {
                moveSlide(1);
            }
        }, 5000);
    });
</script>
</body>
</html>
