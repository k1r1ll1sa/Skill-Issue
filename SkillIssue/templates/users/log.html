{% load static %}
<html>
<head>
    <meta charset="UTF-8">
    <title>Skill Issue</title>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header class="header" id="header">
        <nav class="header-container">
            <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
            <div class="nav-group nav-group-left">
                <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞" data-lang-en="guides">—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</a>
                <a class="nav-links" href="{% url 'announcements_list' %}" data-lang-ru="–æ–±—ä—è–≤–ª–µ–Ω–∏—è" data-lang-en="announcements">–æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
                <a class="nav-links" href="{% url 'favorites_page' %}" data-lang-ru="–∏–∑–±—Ä–∞–Ω–Ω–æ–µ" data-lang-en="favorites">–∏–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
            </div>
            <div class="nav-group nav-group-right">
                <div class="search-container">
                    <input class="search" placeholder="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π" id="searchInput"
                           data-placeholder-ru="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π"
                           data-placeholder-en="search guides, profiles and announcements">
                    <div class="search-dropdown" id="searchDropdown">
                    </div>
                </div>
                <button id="theme-toggle" onclick="window.toggleTheme(event)" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
                <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫">RU</a>
                <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                <div class="context-menu">
                    <a href="{% url 'register_page' %}" data-lang-ru="–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-lang-en="register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                    <a href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="register_container">
        <form id="login_form" style="margin: auto; margin-top: 40px;" class="register_panel" novalidate>
            <p class="simple-text" style="margin: auto; font-size: 2rem" data-lang-ru="–£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã?" data-lang-en="Already registered?">–£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã?</p>
            <p class="simple-text" style="margin: auto; margin-top: -20px; font-size: 1rem" data-lang-ru="–ù–∞–ø–æ–º–Ω–∏—Ç–µ, –∫—Ç–æ –≤—ã?" data-lang-en="Remind us who you are?">–ù–∞–ø–æ–º–Ω–∏—Ç–µ, –∫—Ç–æ –≤—ã?</p>

            <input class="register_input" type="text" id="login_username" placeholder="–≤–≤–µ–¥–∏—Ç–µ username" style="margin: auto"
                   data-placeholder-ru="–≤–≤–µ–¥–∏—Ç–µ username" data-placeholder-en="enter username">
            <input class="register_input" type="password" id="login_password" placeholder="–≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="margin: auto"
                   data-placeholder-ru="–≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" data-placeholder-en="enter password">

            <div style="height: 20px; margin-top: -30px; margin-bottom: -20px">
                <p id="login_error" class="simple-text" style="font-size:0.8rem"></p>
            </div>

            <button type="submit" class="register_button" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</button>
            <a href="{% url 'register_page' %}" class="simple-text" style="color: dimgray; font-size: 1rem; margin-top: -20px" data-lang-ru="–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-lang-en="register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
        </form>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <table class="simple-text" style="width: 100%; height: 100%; color: lightgray; font-size: 1rem">
                <tr>
                    <td colspan="3" style="width:33%;">
                        <a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration: none; color: lightgray; margin-bottom: auto; margin-top: 5px; font-size: 1.25rem"
                           data-lang-ru="–°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç" data-lang-en="Siberian Federal University">–°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</a>
                    <td style="text-align:right">
                        <p class="nav-group-right" style="margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;">@skill_issue 2025</p>
                </tr>
                <tr>
                    <td><p style="text-align:left">@bukohm</p>
                    <td><p style="text-align:center">@hoolkayyy</p>
                    <td><p style="text-align:right">@K1rkaSs</p>
                </tr>
            </table>
        </div>
    </footer>
</body>

<script src="{% static 'js/auth.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('login_form');
    const usernameInput = document.getElementById('login_username');
    const passwordInput = document.getElementById('login_password');
    const error_par = document.getElementById('login_error');

    if (!loginForm) return;

    loginForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !password) {
            error_par.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è";
            return;
        }

        error_par.textContent = '';

        fetch("/api/login/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({username, password}),
            credentials: "include"
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(data => {
                    throw new Error(data.error || `–û—à–∏–±–∫–∞ ${res.status}`);
                });
            }
            return res.json();
        })
        .then(data => {
            if (data.access && data.refresh) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º JWT —Ç–æ–∫–µ–Ω—ã
                authManager.setTokens(data.access, data.refresh, {
                    username: data.username,
                    email: data.email
                });
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                window.location.href = "{% url 'main_page' %}";
            } else {
                error_par.textContent = "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞";
            }
        })
        .catch(err => {
            console.error(err);
            error_par.textContent = err.message || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
        });
    });
});
</script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
