{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
<header class="header" id="header">
    <nav class="header-container">
        <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
        <div class="nav-group nav-group-left">
            <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞" data-lang-en="guides">—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</a>
            <a class="nav-links" href="{% url 'announcements_list' %}" data-lang-ru="–æ–±—ä—è–≤–ª–µ–Ω–∏—è" data-lang-en="announcements">–æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
        </div>
        <div class="nav-group nav-group-right">
            <div class="search-container">
                <input class="search" placeholder="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π" id="searchInput"
                       data-placeholder-ru="–ø–æ–∏—Å–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∞–Ω–∫–µ—Ç –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π"
                       data-placeholder-en="search guides, profiles and announcements">
                <div class="search-dropdown" id="searchDropdown"></div>
            </div>
            <button id="theme-toggle" onclick="window.toggleTheme(event)" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
            <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫">RU</a>
            <div id="menu-container" class="menu-container">
                {% if user.is_authenticated %}
                    <a class="nav-links logout-btn"
                       href="#"
                       data-lang-ru="–≤—ã–π—Ç–∏"
                       data-lang-en="log out"
                       style="margin-right: 24px;">–≤—ã–π—Ç–∏</a>
                {% else %}
                    <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                    <div class="context-menu">
                        <a href="{% url 'register_page' %}" data-lang-ru="–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" data-lang-en="register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                        <a href="{% url 'login_page' %}" data-lang-ru="–≤–æ–π—Ç–∏" data-lang-en="log in">–≤–æ–π—Ç–∏</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </nav>
</header>

<div class="body-background">
    <div id="profile-info" class="profile-row-container" data-username="{{ profile.user.username }}">
        {% if profile.avatar %}
            <img src="{{ profile.avatar.url }}" alt="{{ profile.user.username }}" style="padding: 20px; width: 250px; height: 250px;">
        {% else %}
            <img src="{% static 'images/default-avatar.jpg' %}" alt="avatar" style="padding: 20px; width: 250px; height: 250px;">
        {% endif %}

        <div class="profile-column-container" style="min-width: 67%;">
            <a class="simple-text profile-username" style="font-size: 1.5rem; padding: 20px 0 0 0">{{ profile.user.username }}</a>
            <hr style="color: black; width: 100%;">
            <a class="simple-text profile-description" style="font-size: 1.3rem; padding: 0 0 20px 0">
                {% if profile.bio %}
                    {{ profile.bio }}
                {% else %}
                    <span data-lang-ru="–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" data-lang-en="No description">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>
                {% endif %}
            </a>
            <a class="simple-text profile-rating" style="font-size: 1rem; margin-top: auto; padding: 20px 0 5px 0"
               data-lang-ru="–†–µ–π—Ç–∏–Ω–≥: {{ profile.rating|default:"0"|floatformat:0 }}/5"
               data-lang-en="Rating: {{ profile.rating|default:"0"|floatformat:0 }}/5">
                –†–µ–π—Ç–∏–Ω–≥: {{ profile.rating|default:"0"|floatformat:0 }}/5
            </a>
        </div>
    </div>

    <hr style="color:black; width:96%;">

    <div class="profile-row-container" style="gap:20px; padding:10px 0 0 0; margin-left: 20px; justify-content: flex-start;">
        <button class="profile-button" id="bttn-1" data-lang-ru="—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞" data-lang-en="guides">—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</button>
        <button class="profile-button" id="bttn-2" data-lang-ru="–æ–±—ä—è–≤–ª–µ–Ω–∏—è" data-lang-en="announcements">–æ–±—ä—è–≤–ª–µ–Ω–∏—è</button>
        {% if user == profile.user %}
        <form action="{% url 'profile_edit' %}" method="get" style="margin:0; margin-left:auto;">
            <button class="profile-button" id="bttn-3" data-lang-ru="—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" data-lang-en="edit" style="margin-right: 20px;">—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </form>
        {% endif %}
    </div>

    <div id="guides-container" class="profile-row-container" style="padding:10px 0; gap:20px; margin-left: 20px;">
        {% if guides %}
            {% for guide in guides %}
                <a href="{% url 'guide_detail' guide.id %}" class="guide-link">
                    <div class="guide-element">
                        {% if guide.image %}
                            <img src="{{ guide.image.url }}" class="image-element" alt="{{ guide.title }}">
                        {% else %}
                            <img src="{% static 'images/default-avatar.jpg' %}" class="image-element" alt="guide">
                        {% endif %}
                        <span class="text-element" style="margin:auto;">{{ guide.title }}</span>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <a class="no-guides" style="margin:auto;" data-lang-ru="–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤" data-lang-en="User has no guides">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤</a>
        {% endif %}
    </div>

    <div id="announcements-container" class="profile-row-container" style="padding:10px 0; gap:20px; margin-left: 20px;">
        {% if announcements %}
            {% for ann in announcements %}
                <a class="announcement-link" href="{% url 'announcement_detail' ann.id %}">
                    <div class="guide-element">
                        {% if ann.image %}
                            <img src="{{ ann.image.url }}" class="image-element" alt="{{ ann.title }}">
                        {% else %}
                            <img src="{% static 'images/default-announcement.png' %}" class="image-element" alt="announcement">
                        {% endif %}
                        <span class="text-element" style="margin:auto;">{{ ann.title }}</span>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <a class="no-announcements" style="margin:auto;" data-lang-ru="–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π" data-lang-en="User has no announcements">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</a>
        {% endif %}
    </div>

    {% if user == profile.user %}
    <div style="margin: 20px auto; width: 95%;">
        <a class="simple-text" style="font-size: 1.3rem; margin-bottom: 10px; display: block;">
            –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        </a>
        <div id="activity-container">
            <div style="text-align: center; color: #888; font-style: italic; padding: 20px 0;">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...
            </div>
        </div>
    </div>
    {% endif %}

    <hr style="color:black; width:96%; margin:20px auto;">
    <a class="simple-text" style="line-height:20px; margin-bottom: 20px"
       data-lang-ru="–û—Ç–∑—ã–≤—ã –æ {{ profile.user.username }}"
       data-lang-en="Reviews about {{ profile.user.username }}">–û—Ç–∑—ã–≤—ã –æ {{ profile.user.username }}</a>

    <div id="profile-comments-container" class="profile-column-container" style="gap: 20px; margin-bottom: 10px;">
        {% for review in reviews %}
        <div class="profile-column-container comment-block"
             data-comment-id="{{ review.id }}"
             style="justify-content: left; padding: 10px; background-color: ghostwhite; border-radius: 5px; box-shadow: 0px 1px 2px; width: 75%; margin: auto">

            <div class="profile-row-container" style="gap: 5px; justify-content: flex-start;">
                {% if review.reviewer.profile.avatar %}
                    <img src="{{ review.reviewer.profile.avatar.url }}" class="rec_avatar" alt="{{ review.reviewer.username }}">
                {% else %}
                    <img src="{% static 'images/default-avatar.jpg' %}" class="rec_avatar" alt="avatar">
                {% endif %}

                <div class="profile-column-container">
                    <a href="{% url 'profile_page' review.reviewer.username %}"
                       class="simple-text"
                       style="font-size: 1rem; padding-left: 10px;">
                        {{ review.reviewer.username }}
                    </a>

                    <a class="simple-text"
                       style="font-size: 0.8rem; color: #444; padding-left: 10px;">
                        {{ review.created_at|date:"d.m.Y H:i" }}
                        {% if review.is_edited %}
                            <span class="edited-label" style="color:#666;font-style:italic;">(—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ)</span>
                        {% endif %}
                    </a>
                </div>

                {% if review.reviewer == user %}
                    <button class="profile-button edit-review-btn"
                            data-review-id="{{ review.id }}"
                            data-review-content="{{ review.comment|escapejs }}"
                            style="margin-left:auto;height:30px;min-width:auto;padding:0 10px;"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>

                    <button class="profile-button delete-review-btn"
                            data-review-id="{{ review.id }}"
                            style="margin-left:5px;height:30px;background:#FF6347;color:white;min-width:auto;padding:0 10px"
                            title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                {% endif %}
            </div>

            <a class="simple-text comment-content"
               style="font-size:1rem;padding-top:5px;padding-left:0;text-align:left;display:block;width:100%;margin:0;">
                {{ review.comment }}
            </a>
        </div>

        {% empty %}
        <div class="no-reviews profile-column-container"
             style="justify-content:center;padding:20px;background-color:ghostwhite;border-radius:5px;box-shadow:0px 1px 2px;width:75%;margin:auto">
           <a class="simple-text" style="color:#666; text-align: center;">
                    –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
           </a>
        </div>
        {% endfor %}
    </div>

    {% if user.is_authenticated and user != profile.user %}
    <hr style="width:96%;margin:20px auto;">
    <a class="simple-text" id="review-form-title">–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤</a>

    <form id="review-form" class="profile-column-container">
        {% csrf_token %}
        <input type="hidden" id="review-id-edit">
        <textarea id="review-text" class="textarea_profile" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ–º –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ..."></textarea>
        <a id="review-error" hidden class="simple-text" style="color:red;margin:auto;">
            –û—Ç–∑—ã–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
        </a>
        <button class="profile-button" style="width:20%;margin:auto;" id="review-submit-btn">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
    </form>
    {% elif not user.is_authenticated %}
    <hr style="width:96%;margin:20px auto;">
    <a class="simple-text" style="color:#666;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</a>
    {% endif %}

</div>

    <!-- –ß–∞—Ç -->
    <button type="button" id="floating-button" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
        üí¨
    </button>

    <div id="chat-modal" >
        <div id="chat-contacts">
            <div id="chat-header">
                <span>–ß–∞—Ç—ã</span>
                <button id="chat-close-button">&times;</button>
            </div>
            <!--–°–ü–ò–°–û–ö –ö–û–ù–¢–ê–ö–¢–û–í-->
            <div id="chat-list">
            </div>
        </div>

        <div id="chat-dialog" style="display: none;">
            <div id="dialog-header">
                <button id="back-to-chats">&lt;</button>
                <img id="dialog-avatar" src="{% static 'images/default-avatar.jpg' %}" alt="Avatar">
                <a id="profile-link" href="#">–ù–∏–∫–Ω–µ–π–º</a>
            </div>

            <div id="messages-container" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px;"></div>

            <div style="padding: 15px 20px; background: var(--bg-secondary); border-top: 1px solid var(--border-color);">
            <!-- –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                <div id="image-preview-container" style="display: none; margin-bottom: 10px; position: relative; max-width: 100%;">
                    <img id="image-preview" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"
                         style="max-width: 100%; max-height: 200px; border-radius: 8px; display: block; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                    <button id="remove-image"
                            style="position: absolute; top: -8px; right: -8px; background: #ff4d4d; color: white; border: 2px solid white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;">
                        &times;
                    </button>
                </div>
                <input type="file" id="image-upload" accept="image/png, image/jpeg, image/jpg" style="display: none;">

                <form id="message-form" style="display: flex; gap: 10px; align-items: center; flex-wrap: nowrap;">
                    <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                           style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; font-size: 0.95rem; background: var(--bg-primary); color: var(--text-primary);" autocomplete="off">
                    <button type="button" id="attach-button" style="
                        background: linear-gradient(135deg, #00BFFF 0%, #0099CC 100%);
                        color: white;
                        border: none;
                        width: 45px;
                        height: 36px;
                    border-radius: 20px;
                        padding: 0px 0px;
                    font-size: 0.95rem;
                        cursor: pointer;
                        box-shadow: 0 2px 8px rgba(0, 191, 255, 0.3);
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0, 191, 255, 0.4)';"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0, 191, 255, 0.3)';">
                    üìé
                    </button>

                    <button type="submit" style="
                        background: linear-gradient(135deg, #00BFFF 0%, #0099CC 100%);
                        color: white;
                        border: none;
                        width: 45px;
                        height: 38px;
                    border-radius: 20px;
                        padding: 0px 3px;
                    font-size: 0.95rem;
                        cursor: pointer;
                        box-shadow: 0 2px 8px rgba(0, 191, 255, 0.3);
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0, 191, 255, 0.4)';"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0, 191, 255, 0.3)';">
                         ‚Üµ
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- –ö–æ–Ω–µ—Ü —á–∞—Ç–∞ -->

<footer class="footer">
    <div class="footer-container">
        <table class="simple-text" style="width:100%; height:100%; color:lightgray; font-size:1rem;">
            <tr>
                <td colspan="3" style="width:33%;">
                    <a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration:none; color:lightgray; margin-top:5px; font-size:1.25rem;"
                       data-lang-ru="–°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç"
                       data-lang-en="Siberian Federal University">–°–∏–±–∏—Ä—Å–∫–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</a>
                </td>
                <td style="text-align:right;">
                    <p class="nav-group-right" style="margin-top:5px; font-size:1.25rem;">@skill_issue 2025</p>
                </td>
            </tr>
            <tr>
                <td><p style="text-align:left;">@bukohm</p></td>
                <td><p style="text-align:center;">@hoolkayyy</p></td>
                <td><p style="text-align:right;">@K1rkaSs</p></td>
            </tr>
        </table>
    </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const guidesBtn = document.getElementById("bttn-1");
    const announcementsBtn = document.getElementById("bttn-2");
    const guidesContainer = document.getElementById("guides-container");
    const announcementsContainer = document.getElementById("announcements-container");

    guidesContainer.style.display = "flex";
    announcementsContainer.style.display = "none";
    guidesBtn.classList.add("active-btn");
    announcementsBtn.classList.remove("active-btn");

    guidesBtn.addEventListener("click", () => {
        guidesContainer.style.display = "flex";
        announcementsContainer.style.display = "none";
        guidesBtn.classList.add("active-btn");
        announcementsBtn.classList.remove("active-btn");
    });

    announcementsBtn.addEventListener("click", () => {
        guidesContainer.style.display = "none";
        announcementsContainer.style.display = "flex";
        guidesBtn.classList.remove("active-btn");
        announcementsBtn.classList.add("active-btn");
    });

    const textarea = document.getElementById('review-text');
    const reviewIdInput = document.getElementById('review-id-edit');
    const form = document.getElementById('review-form');
    const errorEl = document.getElementById('review-error');
    const submitBtn = document.getElementById('review-submit-btn');
    const formTitle = document.getElementById('review-form-title');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    const profileUsername = "{{ profile.user.username }}";

    if (!form) return;

    // edit
    document.querySelectorAll('.edit-review-btn').forEach(btn => {
        btn.onclick = () => {
            textarea.value = btn.dataset.reviewContent;
            reviewIdInput.value = btn.dataset.reviewId;
            submitBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
            formTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤";
            textarea.focus();
        };
    });

    // delete
    document.querySelectorAll('.delete-review-btn').forEach(btn => {
        btn.onclick = async () => {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?")) return;
            const commentId = btn.dataset.reviewId;
            const commentBlock = document.querySelector(`.comment-block[data-comment-id="${commentId}"]`);
            
            if (!commentBlock) {
                console.error("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM");
                return;
            }
            
            try {
                const res = await fetch(`/api/profile/comments/${commentId}/delete/`, {
                    method: "DELETE",
                    headers: { "X-CSRFToken": csrfToken }
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (204 No Content –∏–ª–∏ 200 OK)
                if (res.status === 204 || res.status === 200 || res.ok) {
                    commentBlock.remove();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    const remainingComments = document.querySelectorAll('.comment-block');
                    if (remainingComments.length === 0) {
                        const container = document.getElementById('profile-comments-container');
                        container.innerHTML = `
                            <div class="no-reviews profile-column-container"
                                 style="justify-content:center;padding:20px;background-color:ghostwhite;border-radius:5px;box-shadow:0px 1px 2px;width:75%;margin:auto">
                               <a class="simple-text" style="color:#666;">
                                        –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                               </a>
                            </div>
                        `;
                    }
                } else if (res.status === 404) {
                    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–∂–µ —É–¥–∞–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —É–¥–∞–ª—è–µ–º –∏–∑ DOM
                    commentBlock.remove();
                    const remainingComments = document.querySelectorAll('.comment-block');
                    if (remainingComments.length === 0) {
                        const container = document.getElementById('profile-comments-container');
                        container.innerHTML = `
                            <div class="no-reviews profile-column-container"
                                 style="justify-content:center;padding:20px;background-color:ghostwhite;border-radius:5px;box-shadow:0px 1px 2px;width:75%;margin:auto">
                               <a class="simple-text" style="color:#666;">
                                        –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                               </a>
                            </div>
                        `;
                    }
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    const errorData = await res.json().catch(() => ({}));
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", res.status, errorData);
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert –¥–ª—è 404, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ —ç—Ç–æ –≤—ã—à–µ
                    if (res.status !== 404) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                    }
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:", error);
                // –ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
            }
        };
    });

    // submit
    form.onsubmit = async e => {
        e.preventDefault();
        const text = textarea.value.trim();
        if (!text) {
            errorEl.hidden = false;
            return;
        }
        errorEl.hidden = true;

        const isEdit = reviewIdInput.value;
        const url = isEdit
            ? `/api/profile/comments/${reviewIdInput.value}/update/`
            : `/api/profile/comments/create/`;
        const method = isEdit ? "PUT" : "POST";

        const bodyData = isEdit ? { text: text } : { username: profileUsername, comment: text };

        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify(bodyData)
        });

        if (res.ok) {
            const data = await res.json();
            // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            if (isEdit) {
                const commentId = reviewIdInput.value;
                const commentBlock = document.querySelector(`.comment-block[data-comment-id="${commentId}"]`);
                
                if (commentBlock) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç–∏–ª–∏
                    const commentContent = commentBlock.querySelector('.comment-content');
                    if (commentContent) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                        commentContent.setAttribute('style', 'font-size:1rem;padding-top:5px;white-space:pre-wrap;text-align:left;display:block;');
                        commentContent.textContent = data.comment;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É "(—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ)"
                    if (data.is_edited) {
                        const dateContainer = commentBlock.querySelector('.profile-column-container');
                        if (dateContainer) {
                            // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –¥–∞—Ç–æ–π (–≤—Ç–æ—Ä–æ–π <a> –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å —Ü–≤–µ—Ç–æ–º #444)
                            const dateElements = dateContainer.querySelectorAll('a');
                            const dateElement = Array.from(dateElements).find(el => 
                                el.style.color === 'rgb(68, 68, 68)' || 
                                el.style.color === '#444' ||
                                el.getAttribute('style')?.includes('0.8rem')
                            ) || (dateElements.length > 1 ? dateElements[1] : dateElements[0]);
                            
                            if (dateElement) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –º–µ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                                let editedLabel = dateElement.querySelector('.edited-label');
                                if (!editedLabel) {
                                    editedLabel = document.createElement('span');
                                    editedLabel.className = 'edited-label';
                                    editedLabel.style.cssText = 'color:#666;font-style:italic;';
                                    editedLabel.textContent = ' (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ)';
                                    dateElement.appendChild(editedLabel);
                                }
                            }
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º data-review-content –≤ –∫–Ω–æ–ø–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    const editBtn = commentBlock.querySelector('.edit-review-btn');
                    if (editBtn) {
                        const escapedCommentForAttr = data.comment.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        editBtn.dataset.reviewContent = escapedCommentForAttr;
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    textarea.value = '';
                    reviewIdInput.value = '';
                    submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                    formTitle.textContent = "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤";
                } else {
                    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    location.reload();
                }
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                const noReviews = document.querySelector('.no-reviews');
                if (noReviews) noReviews.remove();

                const container = document.getElementById('profile-comments-container');
                const newComment = document.createElement('div');
                newComment.className = 'profile-column-container comment-block';
                newComment.dataset.commentId = data.id;
                newComment.style.cssText = 'justify-content: left; padding: 10px; background-color: ghostwhite; border-radius: 5px; box-shadow: 0px 1px 2px; width: 75%; margin: auto';
                
                const avatarUrl = data.author_avatar || "/static/images/default-avatar.jpg";
                const currentUser = "{{ user.username|default:'' }}";
                const isAuthor = data.author === currentUser;
                
                // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const escapedAuthor = escapeHtml(data.author);
                const escapedComment = escapeHtml(data.comment);
                const escapedCreatedAt = escapeHtml(data.created_at);
                
                let buttonsHtml = '';
                if (isAuthor) {
                    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–ª—è data-–∞—Ç—Ä–∏–±—É—Ç–∞
                    const escapedCommentForAttr = data.comment.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    buttonsHtml = `
                        <button class="profile-button edit-review-btn"
                                data-review-id="${data.id}"
                                data-review-content="${escapedCommentForAttr}"
                                style="margin-left:auto;height:30px;min-width:auto;padding:0 10px;"
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
                        <button class="profile-button delete-review-btn"
                                data-review-id="${data.id}"
                                style="margin-left:5px;height:30px;background:#FF6347;color:white;min-width:auto;padding:0 10px"
                                title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                    `;
                }
                
                newComment.innerHTML = `
                    <div class="profile-row-container" style="gap: 5px; justify-content: flex-start">
                        <img src="${escapeHtml(avatarUrl)}" class="rec_avatar" alt="${escapedAuthor}">
                        <div class="profile-column-container">
                            <a href="/users/${escapedAuthor}/" class="simple-text" style="font-size: 1rem; padding-left: 10px;">${escapedAuthor}</a>
                            <a class="simple-text" style="font-size: 0.8rem; color: #444; padding-left: 10px;">${escapedCreatedAt}</a>
                        </div>
                        ${buttonsHtml}
                    </div>
                    <a class="simple-text comment-content" style="font-size:1rem;padding-top:5px;white-space:pre-wrap;text-align:left;display:block;">${escapedComment}</a>
                `;
                container.prepend(newComment);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
                if (isAuthor) {
                    const editBtn = newComment.querySelector('.edit-review-btn');
                    const deleteBtn = newComment.querySelector('.delete-review-btn');
                    
                    if (editBtn) {
                        editBtn.onclick = () => {
                            textarea.value = editBtn.dataset.reviewContent;
                            reviewIdInput.value = editBtn.dataset.reviewId;
                            submitBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
                            formTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤";
                            textarea.focus();
                        };
                    }
                    
                    if (deleteBtn) {
                        deleteBtn.onclick = async () => {
                            if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?")) return;
                            const commentId = deleteBtn.dataset.reviewId;
                            
                            try {
                                const res = await fetch(`/api/profile/comments/${commentId}/delete/`, {
                                    method: "DELETE",
                                    headers: { "X-CSRFToken": csrfToken }
                                });
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (204 No Content –∏–ª–∏ 200 OK)
                                if (res.status === 204 || res.status === 200 || res.ok) {
                                    newComment.remove();
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                                    const remainingComments = document.querySelectorAll('.comment-block');
                                    if (remainingComments.length === 0) {
                                        const container = document.getElementById('profile-comments-container');
                                        container.innerHTML = `
                                            <div class="no-reviews profile-column-container"
                                                 style="justify-content:center;padding:20px;background-color:ghostwhite;border-radius:5px;box-shadow:0px 1px 2px;width:75%;margin:auto">
                                               <a class="simple-text" style="color:#666; text-align: center">
                                                        –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                                               </a>
                                            </div>
                                        `;
                                    }
                                } else if (res.status === 404) {
                                    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–∂–µ —É–¥–∞–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —É–¥–∞–ª—è–µ–º –∏–∑ DOM
                                    newComment.remove();
                                    const remainingComments = document.querySelectorAll('.comment-block');
                                    if (remainingComments.length === 0) {
                                        const container = document.getElementById('profile-comments-container');
                                        container.innerHTML = `
                                            <div class="no-reviews profile-column-container"
                                                 style="justify-content:center;padding:20px;background-color:ghostwhite;border-radius:5px;box-shadow:0px 1px 2px;width:75%;margin:auto">
                                               <a class="simple-text" style="color:#666;">
                                                        –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                                               </a>
                                            </div>
                                        `;
                                    }
                                } else {
                                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                                    const errorData = await res.json().catch(() => ({}));
                                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", res.status, errorData);
                                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert –¥–ª—è 404, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ —ç—Ç–æ –≤—ã—à–µ
                                    if (res.status !== 404) {
                                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                                    }
                                }
                            } catch (error) {
                                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:", error);
                                // –ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
                            }
                        };
                    }
                }
                
                textarea.value = '';
                reviewIdInput.value = '';
                submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                formTitle.textContent = "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤";
            }
        } else {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            const errorData = await res.json().catch(() => ({}));
            if (errorData.error) {
                errorEl.textContent = errorData.error;
                errorEl.hidden = false;
            } else {
                errorEl.textContent = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è";
                errorEl.hidden = false;
            }
        }
    };
});
</script>

<script src="{% static 'js/auth.js' %}"></script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.querySelector('.logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            authManager.logout();
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è)
    const activityContainer = document.getElementById('activity-container');
    const profileUsername = "{{ profile.user.username }}";
    const currentUser = "{{ user.username|default:'' }}";
    const isOwner = currentUser === profileUsername;
    
    if (activityContainer && profileUsername && isOwner) {
        fetch(`/api/users/${profileUsername}/activities/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load activities');
                }
                return response.json();
            })
            .then(activities => {
                activityContainer.innerHTML = '';
                
                if (activities.length === 0) {
                    const noActivity = document.createElement('div');
                    noActivity.style.cssText = 'text-align: center; color: #888; font-style: italic; padding: 20px 0;';
                    noActivity.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
                    activityContainer.appendChild(noActivity);
                    return;
                }
                
                activities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    const actionText = activity.action_display || activity.action;
                    const targetTypeText = (activity.target_type_display || activity.target_type).toLowerCase();
                    const time = activity.time || (activity.created_at ? activity.created_at.split(' ')[1] : '') || '';
                    
                    let activityHTML = `<span style="color: #666;">${time}</span> `;
                    activityHTML += `<strong>${actionText}</strong> `;
                    activityHTML += `<span>${targetTypeText}</span> `;
                    
                    if (activity.url) {
                        activityHTML += `"<a href="${activity.url}" style="color: #0088cc; text-decoration: none;"><em>${activity.target_title}</em></a>"`;
                    } else {
                        activityHTML += `"<em>${activity.target_title}</em>"`;
                    }
                    
                    activityItem.innerHTML = activityHTML;
                    activityContainer.appendChild(activityItem);
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
                activityContainer.innerHTML = `
                    <div style="text-align: center; color: #888; font-style: italic; padding: 20px 0;">
                        –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    </div>
                `;
            });
    }
});
</script>
<script src="{% static 'js/theme.js' %}"></script>
<script src="{% static 'js/toggle_chat.js' %}"></script>
</body>
</html>
